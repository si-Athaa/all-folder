<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Transport - IGCSE Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
        }

        /* Simulation Container */
        .sim-stage {
            position: relative;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e2e8f0;
        }

        /* Membrane */
        .membrane {
            position: absolute;
            background-image: repeating-linear-gradient(45deg, #cbd5e1 0, #cbd5e1 2px, #fff 2px, #fff 8px);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .membrane-label {
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #475569;
            text-align: center;
        }

        /* Particles */
        .particle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.5s ease-out;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* Energy Flash */
        .energy-flash {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            opacity: 0;
            pointer-events: none;
            color: #fbbf24;
            text-shadow: 0 0 10px #f59e0b;
            z-index: 20;
        }

        @keyframes flash {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .animate-flash {
            animation: flash 0.6s ease-out;
        }

        /* Direction Arrow */
        .direction-arrow {
            position: absolute;
            z-index: 5;
            opacity: 0.6;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        /* Book Styling */
        .book-modal {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .book-hidden {
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
        }
        .book-visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold" id="title-main">Active Transport Simulation</h1>
                <p class="text-sm text-blue-100" id="subtitle-main">IGCSE Combined & Co-ordinated Sciences</p>
            </div>
            <button id="lang-btn" class="bg-white text-blue-700 px-3 py-1 rounded font-bold hover:bg-blue-50 transition shadow">
                INDONESIAN
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 flex flex-col gap-6">

        <!-- Controls & Book Button -->
        <div class="flex flex-wrap gap-4 justify-between items-center bg-white p-4 rounded-lg shadow-sm">
            <button id="open-book-btn" class="flex items-center gap-2 bg-amber-100 text-amber-800 px-4 py-2 rounded-lg hover:bg-amber-200 transition border border-amber-300 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.968 7.968 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                </svg>
                <span id="btn-study-book">Open Study Book</span>
            </button>

            <div class="flex gap-2">
                <button onclick="setSim('root')" id="tab-root" class="px-3 py-1 rounded bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium transition active-tab">Root Hair</button>
                <button onclick="setSim('intestine')" id="tab-intestine" class="px-3 py-1 rounded hover:bg-pink-100 text-slate-600 font-medium transition">Intestine</button>
                <button onclick="setSim('kidney')" id="tab-kidney" class="px-3 py-1 rounded hover:bg-yellow-100 text-slate-600 font-medium transition">Kidney</button>
            </div>
        </div>

        <!-- Simulation Area -->
        <div class="bg-white p-1 rounded-xl shadow-lg border border-slate-200">
            <!-- Sim Header -->
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h2 id="sim-title" class="font-bold text-lg text-slate-700">Root Hair Cell Simulation</h2>
                <div id="atp-meter" class="flex items-center gap-1 text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                    <span id="label-energy">Energy (ATP) Required</span>
                </div>
            </div>

            <!-- Visualization Stage -->
            <div class="p-4">
                <div id="sim-stage" class="sim-stage bg-slate-50 w-full">
                    <!-- Dynamic Content Injected Here -->
                </div>
                
                <!-- Legend -->
                <div class="flex justify-center gap-6 mt-2 text-xs text-slate-500">
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 rounded-full bg-blue-500" id="legend-dot"></div>
                        <span id="legend-particle">Mineral Ions</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <svg class="h-4 w-4 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        <span id="legend-energy">ATP Used</span>
                    </div>
                </div>
            </div>

            <!-- Toggles -->
            <div class="p-4 bg-slate-50 rounded-b-xl border-t border-slate-200 grid grid-cols-2 md:grid-cols-4 gap-4">
                <label class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="toggle-arrows" class="sr-only" checked onchange="renderSimulation()">
                        <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-bg"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-0"></div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-slate-700" id="label-arrows">Show Arrows</div>
                </label>

                <label class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="toggle-gradient" class="sr-only" checked onchange="renderSimulation()">
                        <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-bg"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-0"></div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-slate-700" id="label-gradient">Show Gradient</div>
                </label>

                <label class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="toggle-explanation" class="sr-only" checked onchange="toggleExplanationVis()">
                        <div class="block bg-gray-300 w-10 h-6 rounded-full toggle-bg"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition transform translate-x-0"></div>
                    </div>
                    <div class="ml-3 text-sm font-medium text-slate-700" id="label-explain">Explanation</div>
                </label>

                <button onclick="renderSimulation()" class="text-sm bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded text-slate-700 font-bold transition" id="btn-reset">
                    Reset
                </button>
            </div>
        </div>

        <!-- Explanation Card -->
        <div id="explanation-card" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded shadow transition-all duration-300">
            <h3 class="font-bold text-blue-800 mb-1" id="exp-title">How it works</h3>
            <p class="text-sm text-blue-900 leading-relaxed" id="exp-text">
                Active transport is moving mineral ions from the soil (low concentration) into the root hair cell (high concentration). This requires energy.
            </p>
        </div>

    </main>

    <!-- Mini Study Book Modal -->
    <div id="book-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 book-hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl h-[80vh] rounded-r-xl rounded-l-md shadow-2xl flex flex-col overflow-hidden relative border-l-8 border-amber-700">
            <!-- Book Header -->
            <div class="bg-amber-100 p-4 border-b border-amber-200 flex justify-between items-center">
                <h2 class="font-serif font-bold text-xl text-amber-900" id="book-title">Study Guide: Active Transport</h2>
                <button id="close-book-btn" class="text-amber-800 hover:bg-amber-200 rounded-full p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Book Content -->
            <div class="p-6 overflow-y-auto font-serif text-slate-800 leading-relaxed space-y-6">
                
                <section>
                    <h3 class="text-lg font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2" id="book-h-def">Definition</h3>
                    <p id="book-p-def">The movement of particles through a cell membrane from a region of lower concentration to a region of higher concentration using energy from respiration.</p>
                </section>

                <section class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <h3 class="text-lg font-bold text-amber-800 mb-2" id="book-h-energy">Energy Requirement</h3>
                    <p id="book-p-energy">Unlike diffusion, active transport is an ACTIVE process. It requires energy in the form of ATP, released during respiration in mitochondria.</p>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2" id="book-h-examples">Cambridge Examples</h3>
                    <ul class="list-disc pl-5 space-y-2" id="book-list-examples">
                        <li><strong>Root Hair Cells:</strong> Absorbing mineral ions (like nitrates) from the soil (very dilute) into the cell (higher concentration).</li>
                        <li><strong>Small Intestine (Villi):</strong> Absorbing glucose into the blood when the concentration in the intestine is lower than in the blood.</li>
                        <li><strong>Kidney Tubules:</strong> Reabsorbing all glucose and useful salts back into the blood so they are not lost in urine.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2" id="book-h-diff">Vs. Diffusion & Osmosis</h3>
                    <table class="w-full text-sm text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="p-2 border">Feature</th>
                                <th class="p-2 border">Active Transport</th>
                                <th class="p-2 border">Diffusion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 border" id="tbl-grad">Gradient</td>
                                <td class="p-2 border text-red-600 font-bold" id="tbl-up">Against (Low → High)</td>
                                <td class="p-2 border text-green-600" id="tbl-down">Down (High → Low)</td>
                            </tr>
                            <tr>
                                <td class="p-2 border" id="tbl-nrg">Energy?</td>
                                <td class="p-2 border font-bold" id="tbl-yes">Yes (ATP)</td>
                                <td class="p-2 border" id="tbl-no">No (Passive)</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
            </div>
            
            <div class="bg-amber-50 p-2 text-center text-xs text-amber-800 border-t border-amber-200">
                Cambridge IGCSE Combined Science Syllabus
            </div>
        </div>
    </div>

    <!-- Custom Checkbox CSS Logic -->
    <style>
        input:checked ~ .block {
            background-color: #4ade80;
        }
        input:checked ~ .dot {
            transform: translateX(100%);
        }
        .active-tab {
            background-color: #2563eb !important; /* blue-600 */
            color: white !important;
        }
    </style>

    <script>
        // --- DATA & TRANSLATIONS ---
        const translations = {
            en: {
                title: "Active Transport Simulation",
                subtitle: "IGCSE Combined & Co-ordinated Sciences",
                btnLang: "INDONESIAN", // Button shows target language
                btnBook: "Open Study Book",
                tabRoot: "Root Hair",
                tabIntestine: "Intestine",
                tabKidney: "Kidney",
                labelEnergy: "Energy (ATP) Required",
                legendParticle: "Particles (Ions/Glucose)",
                legendEnergy: "Energy Used",
                lblArrows: "Show Arrows",
                lblGradient: "Show Gradient",
                lblExplain: "Explanation",
                btnReset: "Reset",
                expTitle: "How it works",
                bookTitle: "Study Guide: Active Transport",
                bookHDef: "Definition",
                bookPDef: "The movement of particles through a cell membrane from a region of lower concentration to a region of higher concentration using energy from respiration.",
                bookHEnergy: "Energy Requirement",
                bookPEnergy: "Unlike diffusion, active transport is an ACTIVE process. It requires energy in the form of ATP, released during respiration in mitochondria.",
                bookHEx: "Cambridge Examples",
                bookListEx: `<li><strong>Root Hair Cells:</strong> Absorbing mineral ions (like nitrates) from the soil (very dilute) into the cell (higher concentration).</li>
                             <li><strong>Small Intestine (Villi):</strong> Absorbing glucose into the blood when the concentration in the intestine is lower than in the blood.</li>
                             <li><strong>Kidney Tubules:</strong> Reabsorbing all glucose and useful salts back into the blood so they are not lost in urine.</li>`,
                bookHDiff: "Vs. Diffusion & Osmosis",
                tblGrad: "Gradient",
                tblUp: "Against (Low → High)",
                tblDown: "Down (High → Low)",
                tblNrg: "Energy?",
                tblYes: "Yes (ATP)",
                tblNo: "No (Passive)",
                
                // Simulation Specifics
                simRootTitle: "Root Hair Cell: Mineral Uptake",
                simRootExp: "Plants need mineral ions like nitrates for growth. The concentration in the soil is very low, but high inside the root. The cell uses energy to pump ions IN against the gradient.",
                labelLow: "Low Conc.",
                labelHigh: "High Conc.",
                labelSoil: "Soil",
                labelRoot: "Root Cell",
                
                simIntestineTitle: "Small Intestine: Glucose Absorption",
                simIntestineExp: "After a meal, diffusion works. But later, glucose concentration in the intestine is lower than in the blood. Active transport pumps the remaining glucose into the blood using energy.",
                labelLumen: "Intestine (Lumen)",
                labelBlood: "Blood / Villi",
                
                simKidneyTitle: "Kidney: Selective Reabsorption",
                simKidneyExp: "The kidney filters blood. Useful substances like glucose must be returned to the blood. Active transport pumps them from the tubule (low) back to capillaries (high) so they aren't lost in urine.",
                labelTubule: "Kidney Tubule",
                labelCapillary: "Capillary"
            },
            id: {
                title: "Simulasi Transpor Aktif",
                subtitle: "IGCSE Sains Gabungan & Terkoordinasi",
                btnLang: "ENGLISH",
                btnBook: "Buka Buku Studi",
                tabRoot: "Akar Rambut",
                tabIntestine: "Usus Halus",
                tabKidney: "Ginjal",
                labelEnergy: "Butuh Energi (ATP)",
                legendParticle: "Partikel (Ion/Glukosa)",
                legendEnergy: "Energi Terpakai",
                lblArrows: "Tampil Panah",
                lblGradient: "Tampil Gradien",
                lblExplain: "Penjelasan",
                btnReset: "Reset",
                expTitle: "Cara Kerja",
                bookTitle: "Panduan Belajar: Transpor Aktif",
                bookHDef: "Definisi",
                bookPDef: "Pergerakan partikel melalui membran sel dari daerah berkonsentrasi rendah ke daerah berkonsentrasi lebih tinggi menggunakan energi dari respirasi.",
                bookHEnergy: "Kebutuhan Energi",
                bookPEnergy: "Tidak seperti difusi, transpor aktif adalah proses AKTIF. Ini membutuhkan energi dalam bentuk ATP, yang dilepaskan selama respirasi di mitokondria.",
                bookHEx: "Contoh Cambridge",
                bookListEx: `<li><strong>Sel Rambut Akar:</strong> Menyerap ion mineral (seperti nitrat) dari tanah (sangat encer) ke dalam sel (konsentrasi lebih tinggi).</li>
                             <li><strong>Usus Halus (Vili):</strong> Menyerap glukosa ke dalam darah ketika konsentrasi di usus lebih rendah daripada di dalam darah.</li>
                             <li><strong>Tubulus Ginjal:</strong> Menyerap kembali semua glukosa dan garam yang berguna ke dalam darah agar tidak hilang dalam urin.</li>`,
                bookHDiff: "Vs. Difusi & Osmosis",
                tblGrad: "Gradien",
                tblUp: "Melawan (Rendah → Tinggi)",
                tblDown: "Turun (Tinggi → Rendah)",
                tblNrg: "Energi?",
                tblYes: "Ya (ATP)",
                tblNo: "Tidak (Pasif)",

                simRootTitle: "Sel Rambut Akar: Penyerapan Mineral",
                simRootExp: "Tanaman butuh ion mineral untuk tumbuh. Konsentrasi di tanah sangat rendah, tetapi tinggi di dalam akar. Sel menggunakan energi untuk memompa ion MASUK melawan gradien.",
                labelLow: "Kons. Rendah",
                labelHigh: "Kons. Tinggi",
                labelSoil: "Tanah",
                labelRoot: "Sel Akar",

                simIntestineTitle: "Usus Halus: Penyerapan Glukosa",
                simIntestineExp: "Setelah makan, difusi terjadi. Tapi nanti, konsentrasi glukosa di usus lebih rendah dari di darah. Transpor aktif memompa sisa glukosa ke darah menggunakan energi.",
                labelLumen: "Usus (Lumen)",
                labelBlood: "Darah / Vili",

                simKidneyTitle: "Ginjal: Reabsorpsi Selektif",
                simKidneyExp: "Ginjal menyaring darah. Zat berguna seperti glukosa harus dikembalikan ke darah. Transpor aktif memompa zat dari tubulus (rendah) kembali ke kapiler (tinggi) agar tidak terbuang.",
                labelTubule: "Tubulus Ginjal",
                labelCapillary: "Kapiler"
            }
        };

        // --- STATE ---
        let currentLang = 'en';
        let currentSim = 'root'; // root, intestine, kidney
        let animationInterval = null;
        let particles = [];
        
        // --- DOM ELEMENTS ---
        const stage = document.getElementById('sim-stage');
        
        // --- INIT ---
        window.onload = function() {
            updateText();
            renderSimulation();
        };

        // --- LANGUAGE TOGGLE ---
        document.getElementById('lang-btn').addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'id' : 'en';
            updateText();
            renderSimulation(); // Re-render to update labels inside canvas
        });

        function updateText() {
            const t = translations[currentLang];
            document.getElementById('title-main').innerText = t.title;
            document.getElementById('subtitle-main').innerText = t.subtitle;
            document.getElementById('lang-btn').innerText = t.btnLang;
            document.getElementById('btn-study-book').innerText = t.btnBook;
            document.getElementById('tab-root').innerText = t.tabRoot;
            document.getElementById('tab-intestine').innerText = t.tabIntestine;
            document.getElementById('tab-kidney').innerText = t.tabKidney;
            document.getElementById('label-energy').innerText = t.labelEnergy;
            document.getElementById('legend-particle').innerText = t.legendParticle;
            document.getElementById('legend-energy').innerText = t.legendEnergy;
            document.getElementById('label-arrows').innerText = t.lblArrows;
            document.getElementById('label-gradient').innerText = t.lblGradient;
            document.getElementById('label-explain').innerText = t.lblExplain;
            document.getElementById('btn-reset').innerText = t.btnReset;
            document.getElementById('exp-title').innerText = t.expTitle;
            
            // Book
            document.getElementById('book-title').innerText = t.bookTitle;
            document.getElementById('book-h-def').innerText = t.bookHDef;
            document.getElementById('book-p-def').innerText = t.bookPDef;
            document.getElementById('book-h-energy').innerText = t.bookHEnergy;
            document.getElementById('book-p-energy').innerText = t.bookPEnergy;
            document.getElementById('book-h-examples').innerText = t.bookHEx;
            document.getElementById('book-list-examples').innerHTML = t.bookListEx;
            document.getElementById('book-h-diff').innerText = t.bookHDiff;
            document.getElementById('tbl-grad').innerText = t.tblGrad;
            document.getElementById('tbl-up').innerText = t.tblUp;
            document.getElementById('tbl-down').innerText = t.tblDown;
            document.getElementById('tbl-nrg').innerText = t.tblNrg;
            document.getElementById('tbl-yes').innerText = t.tblYes;
            document.getElementById('tbl-no').innerText = t.tblNo;

            // Update Current Sim Text specifically
            updateSimText();
        }

        function updateSimText() {
            const t = translations[currentLang];
            if(currentSim === 'root') {
                document.getElementById('sim-title').innerText = t.simRootTitle;
                document.getElementById('exp-text').innerText = t.simRootExp;
            } else if (currentSim === 'intestine') {
                document.getElementById('sim-title').innerText = t.simIntestineTitle;
                document.getElementById('exp-text').innerText = t.simIntestineExp;
            } else {
                document.getElementById('sim-title').innerText = t.simKidneyTitle;
                document.getElementById('exp-text').innerText = t.simKidneyExp;
            }
        }

        // --- SIMULATION LOGIC ---

        function setSim(simType) {
            currentSim = simType;
            
            // Update Active Tab Styles
            ['root', 'intestine', 'kidney'].forEach(s => {
                const btn = document.getElementById(`tab-${s}`);
                if(s === simType) {
                    btn.classList.add('active-tab');
                    btn.classList.remove('text-slate-600', 'bg-white');
                } else {
                    btn.classList.remove('active-tab');
                    btn.classList.add('text-slate-600');
                }
            });

            updateSimText();
            renderSimulation();
        }

        function toggleExplanationVis() {
            const el = document.getElementById('explanation-card');
            const chk = document.getElementById('toggle-explanation');
            if(chk.checked) {
                el.classList.remove('hidden');
                el.style.opacity = '1';
            } else {
                el.style.opacity = '0';
                setTimeout(() => el.classList.add('hidden'), 300);
            }
        }

        function renderSimulation() {
            // Clear Stage
            stage.innerHTML = '';
            if(animationInterval) clearInterval(animationInterval);
            particles = [];

            const t = translations[currentLang];
            const showArrows = document.getElementById('toggle-arrows').checked;
            const showGradient = document.getElementById('toggle-gradient').checked;

            // Setup Layout based on Type
            let layout = '';
            let lowLabel = t.labelLow;
            let highLabel = t.labelHigh;
            let lowZone = '', highZone = '';
            let membraneOrientation = 'vertical'; // vertical or horizontal

            if (currentSim === 'root') {
                // Left: Soil (Low), Right: Root (High)
                lowZone = t.labelSoil;
                highZone = t.labelRoot;
                layout = `
                    <div class="absolute inset-0 flex">
                        <div class="w-1/2 h-full bg-amber-50 flex items-end justify-center pb-2 text-slate-400 text-sm font-bold border-r border-dashed border-slate-300">
                            ${showGradient ? `<span class="mb-8">${lowZone} (${lowLabel})</span>` : lowZone}
                        </div>
                        <div class="w-1/2 h-full bg-green-50 flex items-end justify-center pb-2 text-green-700 text-sm font-bold">
                             ${showGradient ? `<span class="mb-8">${highZone} (${highLabel})</span>` : highZone}
                        </div>
                    </div>
                    <div class="membrane h-full w-4 left-1/2 -ml-2 top-0 flex-col">
                        <div class="membrane-label transform -rotate-90 whitespace-nowrap">Membrane</div>
                    </div>
                `;
                if(showArrows) {
                    layout += `<div class="direction-arrow left-1/4 top-1/2 text-4xl transform -translate-y-1/2">
                        <span class="mr-2">Low</span> ➔ <span class="ml-2">High</span>
                    </div>`;
                }
            } else if (currentSim === 'intestine') {
                // Top: Lumen (Low), Bottom: Blood (High)
                membraneOrientation = 'horizontal';
                lowZone = t.labelLumen;
                highZone = t.labelBlood;
                layout = `
                    <div class="absolute inset-0 flex flex-col">
                        <div class="h-1/2 w-full bg-pink-50 flex items-start justify-center pt-2 text-pink-400 text-sm font-bold">
                            ${showGradient ? `<span class="mt-4">${lowZone} (${lowLabel})</span>` : lowZone}
                        </div>
                        <div class="h-1/2 w-full bg-red-100 flex items-end justify-center pb-2 text-red-700 text-sm font-bold">
                            ${showGradient ? `<span class="mb-4">${highZone} (${highLabel})</span>` : highZone}
                        </div>
                    </div>
                    <div class="membrane w-full h-4 top-1/2 -mt-2 left-0 flex-row">
                        <div class="membrane-label">Membrane (Villi)</div>
                    </div>
                `;
                if(showArrows) {
                    layout += `<div class="direction-arrow left-1/2 top-1/4 transform -translate-x-1/2 flex-col">
                        <span>Low</span> <span class="text-3xl">⬇</span> <span>High</span>
                    </div>`;
                }
            } else {
                // Kidney: Left Tubule (Low) -> Right Capillary (High)
                lowZone = t.labelTubule;
                highZone = t.labelCapillary;
                layout = `
                    <div class="absolute inset-0 flex">
                        <div class="w-1/2 h-full bg-yellow-50 flex items-end justify-center pb-2 text-yellow-600 text-sm font-bold border-r border-dashed border-slate-300">
                             ${showGradient ? `<span class="mb-8">${lowZone} (${lowLabel})</span>` : lowZone}
                        </div>
                        <div class="w-1/2 h-full bg-red-50 flex items-end justify-center pb-2 text-red-700 text-sm font-bold">
                             ${showGradient ? `<span class="mb-8">${highZone} (${highLabel})</span>` : highZone}
                        </div>
                    </div>
                    <div class="membrane h-full w-4 left-1/2 -ml-2 top-0 flex-col">
                        <div class="membrane-label transform -rotate-90 whitespace-nowrap">Cell Wall</div>
                    </div>
                `;
                if(showArrows) {
                    layout += `<div class="direction-arrow left-1/4 top-1/2 text-4xl transform -translate-y-1/2">
                        <span class="mr-2">Low</span> ➔ <span class="ml-2">High</span>
                    </div>`;
                }
            }

            stage.innerHTML = layout;

            // Generate Particles
            // Low side gets fewer particles, High side gets more (to illustrate concentration gradient)
            const particleColor = currentSim === 'root' ? 'bg-blue-500' : (currentSim === 'intestine' ? 'bg-purple-500' : 'bg-green-500');
            
            let lowCount = 5;
            let highCount = 20;

            // Create initial High side particles (Static mostly, just wiggling)
            for(let i=0; i<highCount; i++) {
                createParticle(highZoneType(), particleColor, false);
            }

            // Create Low side particles that will move
            for(let i=0; i<lowCount; i++) {
                createParticle(lowZoneType(), particleColor, true);
            }

            // Start Animation Loop
            animationInterval = setInterval(animateParticles, 50);
        }

        function lowZoneType() {
            if (currentSim === 'intestine') return 'top';
            return 'left';
        }

        function highZoneType() {
            if (currentSim === 'intestine') return 'bottom';
            return 'right';
        }

        function createParticle(zone, colorClass, isMover) {
            const p = document.createElement('div');
            p.className = `particle ${colorClass}`;
            
            let x, y;
            // Random positioning based on zone
            if (zone === 'left') {
                x = Math.random() * 45; // 0-45% width
                y = Math.random() * 90 + 5;
            } else if (zone === 'right') {
                x = Math.random() * 45 + 52; // 52-97% width
                y = Math.random() * 90 + 5;
            } else if (zone === 'top') {
                x = Math.random() * 90 + 5;
                y = Math.random() * 40; // 0-40% height
            } else if (zone === 'bottom') {
                x = Math.random() * 90 + 5;
                y = Math.random() * 40 + 55; // 55-95% height
            }

            p.style.left = x + '%';
            p.style.top = y + '%';
            
            // Store data for animation
            p.dataset.x = x;
            p.dataset.y = y;
            p.dataset.isMover = isMover; // Only low conc particles move across
            p.dataset.crossed = "false";
            p.dataset.zone = zone;

            stage.appendChild(p);
            particles.push(p);
        }

        function animateParticles() {
            particles.forEach(p => {
                let x = parseFloat(p.dataset.x);
                let y = parseFloat(p.dataset.y);
                const isMover = p.dataset.isMover === 'true';

                // Random wiggle
                x += (Math.random() - 0.5) * 0.5;
                y += (Math.random() - 0.5) * 0.5;

                // Active Transport Logic (Move against gradient)
                if (isMover) {
                    if (currentSim === 'root' || currentSim === 'kidney') {
                        // Move Right (Left -> Right)
                        x += 0.4; 
                        
                        // Check Membrane Crossing
                        if (x > 50 && p.dataset.crossed === "false") {
                            triggerEnergyFlash(50, y);
                            p.dataset.crossed = "true";
                        }

                        // Reset if it goes off screen
                        if (x > 95) {
                            x = 5;
                            p.dataset.crossed = "false";
                        }

                    } else if (currentSim === 'intestine') {
                        // Move Down (Top -> Bottom)
                        y += 0.4;

                        if (y > 50 && p.dataset.crossed === "false") {
                            triggerEnergyFlash(x, 50);
                            p.dataset.crossed = "true";
                        }

                        if (y > 95) {
                            y = 5;
                            p.dataset.crossed = "false";
                        }
                    }
                }

                // Bounds check roughly
                if(x < 2) x = 2; if(x > 98) x = 98;
                if(y < 2) y = 2; if(y > 98) y = 98;

                p.style.left = x + '%';
                p.style.top = y + '%';
                p.dataset.x = x;
                p.dataset.y = y;
            });
        }

        function triggerEnergyFlash(xPercent, yPercent) {
            const flash = document.createElement('div');
            flash.className = 'energy-flash animate-flash';
            flash.innerHTML = '⚡ ATP'; 
            flash.style.left = xPercent + '%';
            flash.style.top = yPercent + '%';
            stage.appendChild(flash);
            
            // Cleanup DOM
            setTimeout(() => {
                flash.remove();
            }, 600);
        }

        // --- BOOK MODAL LOGIC ---
        const bookOverlay = document.getElementById('book-overlay');
        document.getElementById('open-book-btn').addEventListener('click', () => {
            bookOverlay.classList.remove('book-hidden');
            bookOverlay.classList.add('book-visible');
        });
        document.getElementById('close-book-btn').addEventListener('click', () => {
            bookOverlay.classList.remove('book-visible');
            bookOverlay.classList.add('book-hidden');
        });
        // Close on clicking outside
        bookOverlay.addEventListener('click', (e) => {
            if(e.target === bookOverlay) {
                bookOverlay.classList.remove('book-visible');
                bookOverlay.classList.add('book-hidden');
            }
        });

    </script>
</body>
</html>
